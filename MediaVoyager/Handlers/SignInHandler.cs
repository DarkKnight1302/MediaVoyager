using NewHorizonLib.Services.Interfaces;

namespace MediaVoyager.Handlers
{
    public class SignInHandler : ISignInHandler
    {
        private readonly IEmailService _emailService;
        private readonly IOtpService _otpService;

        public SignInHandler(IEmailService emailService, IOtpService otpService)
        {
            _emailService = emailService;
            _otpService = otpService;
        }

        public async Task SendOtpEmail(string email)
        {
            string otp = _otpService.GenerateOtp(email);
            string otpEmailBody = OtpEmailTemplate(otp);
            await _emailService.SendMail(email, otpEmailBody, "Your Media Voyager Verification Code", "MediaVoyager", "noreply@mediavoyager.in", true);
        }

        private string OtpEmailTemplate(string otp)
        {
            string emailTemplate = "<!DOCTYPE html>\r\n<html lang=\"en\" style=\"margin:0;padding:0;\">\r\n<head>\r\n  <meta charset=\"UTF-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width\">\r\n  <title>Media Voyager - Email Verification</title>\r\n  <style>\r\n    /* Keep CSS minimal for email clients, all static (no animations) */\r\n    body {\r\n      margin: 0;\r\n      padding: 0;\r\n      background: #0a1024;\r\n      -webkit-text-size-adjust: 100%;\r\n      -ms-text-size-adjust: 100%;\r\n      font-family: Arial, Helvetica, sans-serif;\r\n    }\r\n    .preheader {\r\n      display: none !important; visibility: hidden; opacity: 0; color: transparent;\r\n      height: 0; width: 0; overflow: hidden; mso-hide: all; line-height: 0; max-height: 0; max-width: 0;\r\n    }\r\n    .container {\r\n      width: 100%;\r\n      background: #0a1024;\r\n    }\r\n    .wrap {\r\n      max-width: 600px;\r\n      margin: 0 auto;\r\n    }\r\n    .card {\r\n      background: linear-gradient(180deg, #000814 0%, #001933 50%, #002b55 100%);\r\n      border-radius: 16px;\r\n      overflow: hidden;\r\n      border: 1px solid rgba(0, 210, 211, 0.15);\r\n    }\r\n    /* Static hero */\r\n    .hero {\r\n      position: relative;\r\n      height: 320px;\r\n      background:\r\n        radial-gradient(1100px 540px at 50% 110%, rgba(0, 90, 140, .22), transparent 60%),\r\n        radial-gradient(800px 400px at 20% -20%, rgba(160, 60, 200, .14), transparent 60%),\r\n        radial-gradient(900px 450px at 80% -10%, rgba(0, 210, 211, .14), transparent 60%),\r\n        radial-gradient(circle at 50% 40%, #001d3d 0%, #000814 60%);\r\n      color: #00d2d3;\r\n      text-align: center;\r\n    }\r\n    .stars {\r\n      position: absolute; inset: 0;\r\n      background-image:\r\n        radial-gradient(1px 1px at 8% 18%, rgba(255,255,255,.9), transparent 40%),\r\n        radial-gradient(1.25px 1.25px at 22% 64%, rgba(255,215,0,.85), transparent 45%),\r\n        radial-gradient(1px 1px at 40% 34%, rgba(78,205,196,.85), transparent 45%),\r\n        radial-gradient(1px 1px at 70% 24%, rgba(255,182,193,.85), transparent 45%),\r\n        radial-gradient(1.25px 1.25px at 84% 70%, rgba(162,155,254,.8), transparent 45%),\r\n        radial-gradient(1px 1px at 60% 84%, rgba(0,210,211,.85), transparent 45%),\r\n        radial-gradient(1px 1px at 14% 84%, rgba(255,255,255,.8), transparent 45%),\r\n        radial-gradient(1.25px 1.25px at 90% 48%, rgba(255,215,0,.8), transparent 45%);\r\n      background-size: 320px 200px;\r\n      opacity: .9;\r\n    }\r\n    .brand {\r\n      position: relative;\r\n      padding-top: 22px;\r\n      z-index: 1;\r\n    }\r\n    .brand-title {\r\n      font-weight: 800;\r\n      letter-spacing: 2.4px;\r\n      font-size: 24px;\r\n      color: #00d2d3;\r\n      text-shadow: 0 0 14px rgba(0, 210, 211, .6);\r\n    }\r\n    .brand-sub {\r\n      margin-top: 6px;\r\n      font-size: 12px;\r\n      color: #8cc8ff;\r\n      letter-spacing: 1.1px;\r\n    }\r\n\r\n    .content {\r\n      padding: 36px 24px 28px 24px;\r\n      text-align: center;\r\n      color: #ffffff;\r\n    }\r\n    .welcome { font-size: 22px; font-weight: 700; margin-bottom: 10px; color: #00d2d3; }\r\n    .desc { font-size: 15px; line-height: 1.6; margin: 0 auto 22px auto; color: #b3d9ff; max-width: 520px; }\r\n\r\n    .otp {\r\n      background: linear-gradient(135deg, #003566 0%, #0077b6 100%);\r\n      border-radius: 14px;\r\n      padding: 24px;\r\n      margin: 16px auto 4px auto;\r\n      border: 2px solid #00d2d3;\r\n      box-shadow: 0 10px 24px rgba(0, 210, 211, 0.24);\r\n      max-width: 520px;\r\n    }\r\n    .otp-label { font-size: 15px; font-weight: 600; margin-bottom: 10px; color: #ffffff; }\r\n    .otp-code {\r\n      font-family: Consolas, \"Courier New\", Courier, monospace;\r\n      font-size: 32px; font-weight: 900; color: #FFD700; /* <-- MODIFIED COLOR */\r\n      letter-spacing: 8px; text-shadow: 0 0 12px rgba(255, 215, 0, .6); /* <-- MODIFIED SHADOW */\r\n      margin-bottom: 8px;\r\n    }\r\n    .otp-expiry { font-size: 13px; color: #ffd166; font-weight: 600; }\r\n\r\n    .instructions {\r\n      background: rgba(0, 210, 211, 0.10);\r\n      border-radius: 10px;\r\n      padding: 16px;\r\n      margin: 18px auto 0 auto;\r\n      border-left: 4px solid #00d2d3;\r\n      text-align: left;\r\n      color: #b3d9ff;\r\n      max-width: 520px;\r\n      font-size: 14px;\r\n      line-height: 1.55;\r\n    }\r\n    .instructions-title { font-weight: 700; margin-bottom: 6px; color: #00d2d3; }\r\n\r\n    .footer {\r\n      background: rgba(0,0,0,0.35);\r\n      padding: 18px 16px 24px 16px;\r\n      text-align: center;\r\n      border-top: 1px solid rgba(0, 210, 211, 0.25);\r\n    }\r\n    .footer-text { font-size: 12px; color: #8cc8ff; line-height: 1.5; }\r\n    .tagline { font-style: italic; color: #00d2d3; margin-top: 6px; }\r\n\r\n    /* Simple mobile tweaks */\r\n    @media only screen and (max-width: 600px) {\r\n      .wrap { margin: 10px; }\r\n      .hero { height: 300px; }\r\n      .brand-title { font-size: 20px; letter-spacing: 2px; }\r\n      .otp-code { font-size: 26px; letter-spacing: 6px; }\r\n      .content { padding: 28px 18px; }\r\n    }\r\n  </style>\r\n</head>\r\n<body>\r\n  <div class=\"preheader\">Your Media Voyager verification code is inside. It expires in 10 minutes.</div>\r\n\r\n  <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" class=\"container\">\r\n    <tr>\r\n      <td align=\"center\">\r\n        <div class=\"wrap\">\r\n          <div class=\"card\" role=\"article\" aria-roledescription=\"email\">\r\n            <div class=\"hero\" role=\"img\" aria-label=\"Voyager probe flying through a starry blue space background\">\r\n              <div class=\"stars\" aria-hidden=\"true\"></div>\r\n\r\n              <div class=\"brand\">\r\n                <div class=\"brand-title\">MEDIA VOYAGER</div>\r\n                <div class=\"brand-sub\">Discover • Watch • Enjoy</div>\r\n              </div>\r\n\r\n              <img src=\"https://i.ibb.co/L9CqXzV/voyager-probe-transparent.png\"\r\n                   alt=\"Voyager Spacecraft\"\r\n                   width=\"180\"\r\n                   style=\"display: block; margin: 25px auto 0; max-width: 180px; height: auto; position: relative; z-index: 2;\">\r\n\r\n            </div>\r\n\r\n            <div class=\"content\">\r\n              <div class=\"welcome\">Welcome to Your Cinematic Journey!</div>\r\n              <div class=\"desc\">\r\n                Your AI-powered companion for discovering amazing movies and TV shows is ready to launch.\r\n                Complete your email verification to begin exploring personalized recommendations tailored just for you.\r\n              </div>\r\n\r\n              <div class=\"otp\" role=\"group\" aria-label=\"Verification code\">\r\n                <div class=\"otp-label\">Your Verification Code:</div>\r\n                <div class=\"otp-code\">{{OTP_CODE}}</div>\r\n                <div class=\"otp-expiry\">⏰ Expires in 10 minutes</div>\r\n              </div>\r\n\r\n              <div class=\"instructions\">\r\n                <div class=\"instructions-title\">🔐 Verification Instructions</div>\r\n                1. Copy the 6-digit code above<br>\r\n                2. Return to the Media Voyager app<br>\r\n                3. Paste the code in the verification field<br>\r\n                4. Start your personalized entertainment journey!\r\n              </div>\r\n            </div>\r\n\r\n            <div class=\"footer\">\r\n              <div class=\"footer-text\">\r\n                This email was sent from Media Voyager.<br>\r\n                If you didn't request this verification, please ignore this email.\r\n                <div class=\"tagline\">🌟 \"Discover. Watch. Enjoy.\" 🌟</div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </td>\r\n    </tr>\r\n  </table>\r\n</body>\r\n</html>";

            return emailTemplate.Replace("{{OTP_CODE}}", otp);
        }
    }
}
